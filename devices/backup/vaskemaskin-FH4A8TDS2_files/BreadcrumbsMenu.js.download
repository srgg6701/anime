/***
 * Module BreadcrumbsMenu
 */
Site.BreadcrumbsMenu = (function (window, S, $) {
    
    return {
        init : function () {

            var $breadcrumbs = $('.master-head .breadcrumbs').find('li:not(.no-dropdown)'),
                $masterMain = $('.master-main'),
                $br1El = $breadcrumbs.first(),
                $br2El = null,
                br1Index = $br1El.index(),
                br2Index = null,
                br1Text = $br1El.text().trim(), 
                br2Text = null,
                $menu1 = $('<ul></ul>'),
                $menu2 = $('<ul></ul>');
           
            if (!$breadcrumbs.length) {
                return false;
            } else if ($breadcrumbs.length > 1) {
                $br2El = $breadcrumbs.eq(1);
                br2Text = $br2El.text().trim();
                br2Index = $br2El.index();
            }
            
            $breadcrumbs = $breadcrumbs.filter(function( index ) {
                return index < 2;
            });

            $('#mainCategories .top-menu-link').each(function(k, el){
                var $el = $(el),
                    text = $el.text().trim();
                
                if (text === br1Text) {
                  if (br2Text) {
                    $el.parent().find('.sub-menu-container .sub-menu-section:not(.campaign-section) .sub-menu-link').each(function(kk, subEl) {
                      var $subEl = $(subEl);
                      if (br2Text != $subEl.text().trim()) {
                        $menu2.append($('<li></li>').html($subEl.clone().attr('class','')));
                      }
                    });
                  }
                } else {
                  $menu1.append($('<li></li>').html($el.clone().attr('class','')));
                }
            });
            
            $menu1 = $('<div class="breadcrumb-dropdown brc1Menu"></div>').html($menu1);
            $menu2 = $('<div class="breadcrumb-dropdown brc2Menu"></div>').html($menu2);
            $masterMain.append($menu1);
            if (br2Text) {
             $masterMain.append($menu2);
            }    
            
            var siteWrapper = document.getElementById('site-wrapper'),
                upPosition = function() {
                  var l = siteWrapper.getBoundingClientRect().left,
                      br1ElRect = $br1El.children()[0].getBoundingClientRect();
                  
                  $menu1.css('left', br1ElRect.left - l).css('top', '0px');
   
                  if (br2Text) {
                      $menu2.css('left', $br2El.children()[0].getBoundingClientRect().left - l).css('top', '0px');
                  }
                  
                  var br1ElTop = parseInt(br1ElRect.top + br1ElRect.height),
                      menu1Top = parseInt($menu1[0].getBoundingClientRect().top);
                  if (menu1Top > br1ElTop) {
                      var newTop = -(menu1Top - br1ElTop);
                      $menu1.css('top', newTop);
                      
                      if (br2Text) {
                          $menu2.css('top', newTop);
                      }
                  }

                };

            upPosition();
            var firstHover = true;
        
            $breadcrumbs.on('mouseenter', function() {
                if (firstHover) {
                    firstHover = false;
                    upPosition();
                }
                var $this = $(this),
                    i = $this.index(),
                    $act;

                if (i === br1Index) {
                    $act = $menu1;
                } else if (i === br2Index) {
                    $act = $menu2;
                }
                
                if ($act) {
                    $this.addClass('active');
                    $act.addClass('active');
                }
            }).on('mouseleave', function() {
                var $this = $(this),
                    i = $this.index(),
                    $act;
              
                if (i === br1Index) {
                    $act = $menu1;
                } else if (i === br2Index) {
                    $act = $menu2;
                }
                
                if ($act) {
                    $this.removeClass('active');
                    $act.removeClass('active');
                }
            });
        
            $menu1.on('mouseenter', function() {
                $br1El.trigger('mouseenter');
            }).on('mouseleave', function() {
                $br1El.trigger('mouseleave');
            });
        
            $menu2.on('mouseenter', function() {
                $br2El.trigger('mouseenter');
            }).on('mouseleave', function() {
                $br2El.trigger('mouseleave');
            });
        
            var tId;
            $(window).on('resize', function() {
                if (tId) {clearTimeout(tId);}
                tId = setTimeout(upPosition, 100);
            });
        }
    };
    
}(this, Site, jQuery));