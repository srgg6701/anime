/**
 * Module Init
 * Executes functions required to run on every page visit.
 */
Site.Init = (function (window, S, $) {    

    $(function () {
        var rwd = S.RWD,
            out = S.Common.out,
            conf = S.Config,
            end;

        globals.perfTimer.init = new Date();
        globals.perfTimer.docReady = globals.perfTimer.init - globals.perfTimer.docReady;
        
        out('Initiating site..');
       
        
        $( window ).on( "load", function() {
            /**
             * Call to Bazaarvoice to set the inline ratings for products.
             * One call for normal products, and one call for products from Adobe Recommendations.
             */
            try {
                if(globals.BVRatingStarProducts.length > 0) {
                    $BV.ui( 'rr', 'inline_ratings', {
                        productIds : globals.BVRatingStarProducts,
                        containerPrefix : 'BVRRInlineRating'
                    });
                }
                       
                if(globals.BVAdobeRatingStarProducts.length > 0) {
                    $BV.ui( 'rr', 'inline_ratings', {
                        productIds : globals.BVAdobeRatingStarProducts,
                        containerPrefix : 'BVRRAdobeInlineRating'
                    });         
                }           
            }
            catch (e) { Site.Common.out(e.message, 'error'); } 
            
        });
        
        $.fn.placeholder && $('input, textarea').placeholder();
        
        S.Common.checkIfIE();
        /*
         * Omniture
         */
        $('.sub-menu-container .sub-menu-section .level-two-category').on('click', function() {
                $this = $(this);
                try {
                    s_objectID = 'Category Menu Level2 ' + $this.html();
                    s.linkName = $this.html();
                }
                catch (e) { out('SiteCatalyst: ' + e.message, 'error'); }
            }
        );
        
        /*
         * Closes the cookie information overlay and sets the 'cookieconsent' cookie.
         */
        $('.cookie-info-close').on('click', function() {            
            var days = globals.cookieConsent['days'] || 30;

            $('.cookie-info-layer').hide();
            S.Common.setCookie('cookieconsent', 'yes', days);           
        });     
                
        /*
         * Functions to run if Media Queries are supported.
         */
        if (rwd.supportsMq) {
            
            rwd.initMediaQueries();
            
            /* RWD behaviour for AddProductByAjax */
            !conf.isTemplateInteraction('checkout10')
                && S.AddProductByAjax.rwdSetup();
            
            /* RWD behavior for the CompareBox */
            !conf.isTemplateInteraction('checkout10')
                && S.CompareBox.rwdSetup();
                        
            /* RWD behavior for the Product Detail Page */
            conf.isTemplateInteraction('productDetailPage')
                && S.ProductDetailPage.rwdSetup();
            
            /* RWD behaviour for My page wishlist details*/
            conf.isTemplateInteraction('myPageWishlist')
                && S.MyPageWishlist.rwdSetup();
            
            /* RWD behaviour for Checkout */
            conf.isTemplateInteraction('checkout')
                && S.Checkout.rwdSetup();
            
            /* RWD behaviour for Checkout10 */
            conf.isTemplateInteraction('checkout10')
                && S.CheckoutC10.rwdSetup();
            
            /* RWD behaviour for Article pages */
            conf.isTemplateInteraction('articlePage')
                && S.ArticlePage.rwdSetup();
            
            /* RWD behaviour for Subscriptions. Only run on product detail page. */
            conf.isTemplateInteraction('productDetailPage') 
                && S.Subscription.rwdSetup();
            
            /* BigBang background image. */
            S.Bigbang.initImage();           
                        
            /* Check for any RWD functions to run. */
            setTimeout(function () {
                rwd.refresh();
            }, 200);
            
        } else {
            out('Media Queries are not supported.');
                             
            S.Bigbang.initImage();           
        }        
        
        
        if(!conf.isTemplateInteraction('checkout10')) {
            /*
             * Initialize main category menu responsive behavior.
             */
            S.FoldMenu.setup('#mainCategories', '.menu-toggle, #mainCategories .close');    
    
            /*
             * Initiate the Mini Basket.
             */
            S.MiniBasket.init('#minibasket-counter');            

            /*
             * Initiate Search-as-you-type.
             */
            S.SAYT.init();
                        
            /*
             * Init script for adding products by AJAX.
             */
            S.AddProductByAjax.init();
            
            /*
             * Init geolocation
             */
            S.Geolocation.displayMyStore();
            
         
            /*
             * Get logged in session status
             */        
            Site.Common.getSessionStatus(Site.Login.handleLoginState);
        }

        /*
         * Initiate Product Detail Page if necessary.
         */
        conf.isTemplateInteraction('productDetailPage') 
            && S.ProductDetailPage.init();
        
        
        /*
         * Initiate Category Level 1 if necessary.
         */
        conf.isTemplateInteraction('categoryLevel1') 
            && S.CategoryLevel1.init();
        
        /*
         * Initiate product filter page.
         */
        conf.isTemplateInteraction('filterNavigation') 
            && new S.View.FilterNavigation();
        
        /*
         * Initiate Article Page if necessary.
         */
        conf.isTemplateInteraction('articlePage') 
            && S.ArticlePage.init();        
         
        /*
         * Initiate Change password page if necessary.
         */
        conf.isTemplateInteraction('passwordStrengthCheck')
            && S.PasswordStrengthCheck.init();
    
        /*
         * Initiate My Page personal info if necessary.
         */
        conf.isTemplateInteraction('myPagePersonalInfo')
            && S.MyPagePersonalInfo.init();
        
        /*
         * Initiate My Page Wishlist details if necessary.
         */
        conf.isTemplateInteraction('myPageWishlist')
            && S.MyPageWishlist.init();
        
        /*
         * Initiate Endless scroll.
         */
        conf.isTemplateInteraction('endlessScroll') 
            && S.EndlessScroll.init();   

        /*
         * Initiate Order Page if necessary.
         */
        conf.isTemplateInteraction('myPageOrderDetails') 
            && S.MyPageOrderDetails.init();        
        
        /*
         * Initiate Order History if necessary.
         */
        conf.isTemplateInteraction('myPageOrderHistory') 
            && S.MyPageOrderHistory.init();
         
        /*
         * Initiate Login page
         */
        conf.isTemplateInteraction('login')
            && S.Login.init();
        
        /*
         * Initiate Insurance renewal left bar 
         */
        conf.isTemplateInteraction('insuranceRenewal')
            && S.InsuranceRenewal.init();
            
        /*
         * Initiate Seller popup
         */
        conf.isTemplateInteraction('sellerPopup')
            && S.Common.sellerRating();
           

        /**
         * Init Registration page.
         */
        conf.isTemplateInteraction('registration') 
            && S.Registration.init();
        
        
        /**
         * Prepare Compare box.
         */
        conf.isTemplateInteraction('compareBox') &&
        //S.CompareBox.init('#product-comparisons', '.add-to-compare', '.close-all', '#product-comparisons .remove-all');
        S.CompareBox.init();
        
        
        /**
         * Check for any forms to validate.
         */
        $('form').length 
            && S.Validation.init();
               
    
        /**
         * Load scripts for the checkout pages.
         */
        conf.isTemplateInteraction('checkout10') 
            && S.CheckoutC10.init();
        
        conf.isTemplateInteraction('checkoutReceipt') 
            && S.CheckoutReceiptC10.init();
        
        /**
         * Check for calendars
         */
        if (conf.isTemplateInteraction('checkout10')) {
            (function (cals) {
                if (cals.length) {
                    S.Calendar.init(cals);
                }
            })($('.calendar-wrap') || []);
        }
        
        /**
         * Remove CardDetails Stored in session if the current page != checkout10
         * also remove Santander SSN in session
         */
        !conf.isTemplateInteraction('checkout10')
            && S.Common.removeCardSessionObjects();
        
        !conf.isTemplateInteraction('checkout10')
            && S.Common.removeSessionSSN();
        
        /**
         * Init scripts for highlighting comparison products.
         */
        conf.isTemplateInteraction('comparePage')
            && S.CompareBox.initComparePage();        
        
        /**
         * Init collect@store module.
         */
        conf.isTemplateInteraction('productDetailPage') 
            && S.CollectAtStore.init();
        
        conf.isTemplateInteraction('articlePage')
            && S.CollectAtStore.init();
        
        S.Common.populateNewsletterEmail();
        
        S.Common.newsletterCheckbox();
        
        /**
         * Call to check if we should display the cookie information layer at the bottom of the page.
         */
        S.Common.showCookieConsent();
        
        /**
         * Dropdown button global triggger
         */
        S.Common.dropdownButton();
        
        /**
         * Call Expanded boxes function.
         */
        S.Common.expandBox();
        
        /**
         * Call for touch device detect
         */
         Site.Common.isTouch();
            
        /**
         * Call for new design Button Animations
         */
        S.Buttons.init();
           
        /**
         * Call for Select list with details and Select list Common
         */
        S.Common.selectListWD();
        S.Common.selectListCommon();
        

        
        try {
            S.Common.handleBarsHelpers();
        }
        catch (e) { Site.Common.out(e.message, 'error'); } 
        
        
        /*
         * Fixed mobile header - ECOM-16746
        */
        Site.Common.fixedMobileHeader();
        
        
        /**
         * Init Breadcrumbs Menu.
         */
        conf.isTemplateInteraction('breadcrumbsMenu') 
            && S.BreadcrumbsMenu.init();

        
        /**
         * PLEASE LET THIS ROW BE THE LAST ONE, OTHERWISE THE PERFORMANCE TIMER WILL
         * NOT BE ACCURATE. PLACE ADDITIONAL INIT SCRIPTS ABOVE THIS LINE.
         */
        end = new Date();
        globals.perfTimer.init = end - globals.perfTimer.init;
        globals.perfTimer.end = end - globals.perfTimer.start;

    });
    
    var createApplePayCookie = function(canMakePayments) {
        if (canMakePayments === true) {
            Site.Common.setCookieEncoded('ApplePayAllowed', true, 365, true);
        } else {
            Site.Common.setCookieEncoded('ApplePayAllowed', false, 365, true);
        }
    };
    
window.onload = function() {
    
    /**
     * Initiate Royal sliders.
     * Initiate News Slider
     * MOVED to defer loading until elements on page exist. ECOM-13684
     * @author Andrew Corliss
     */
    if (Site.Config.isTemplateInteraction('royalSlider')) {
       setTimeout(function() {
           Site.Slider.initRoyal();
           // TODO : Investigate if this still is in use on site.
           Site.Slider.initNews();
       }, 300);
    }
    
    if (window.performance && window.performance.timing) {
        setTimeout(function() {
            var t = performance.timing;
            globals.perfTimer.pageLoad = t.loadEventEnd - t.responseEnd;
            globals.perfTimer.networkLatency = t.responseEnd - t.fetchStart;
            globals.perfTimer.navigationProcess = t.loadEventEnd - t.navigationStart;
        }, 0);
    }
    
    if (!Site.Common.getCookieValue('ApplePayAllowed')) {
        
        if (window.ApplePaySession) {
            var merchantIdentifier = (globals.applePayMerchantID) ? globals.applePayMerchantID : 'merchant.com.elkjopecom.elkjop';
            var promise = ApplePaySession.canMakePaymentsWithActiveCard(merchantIdentifier);
                promise.then(createApplePayCookie(true));
        } else {
           createApplePayCookie(false);
        }
    }
    
    /**
     * ECOM-17721 - fix spinner for IE
     */
    if ($("html").hasClass("ie-edge")) {
        var newStyle = document.createElement('style'),
            staticPath = $('link[href*="/site."]').attr('href');
        
        if (staticPath && staticPath.indexOf('/css/') >= 0) {
            staticPath = staticPath.split('/css/')[0];
        } else {
            staticPath = null;
        }
        
        if (staticPath) {
          newStyle.appendChild(document.createTextNode("\
              @font-face {\
                font-family: 'FontAwesomeOrg';\
                font-display: fallback;\
                src: local('FontAwesomeOrg'), url('" + staticPath + "/fonts/fontawesome-webfont.eot?v=4.3.0');\
                src: url('" + staticPath + "/fonts/fontawesome-webfont.eot?#iefix&v=4.3.0') format('embedded-opentype'), url('" + staticPath + "/fonts/fontawesome-webfont.woff2?v=4.3.0') format('woff2'), url('" + staticPath + "/fonts/fontawesome-webfont.woff?v=4.3.0') format('woff'), url('" + staticPath + "/fonts/fontawesome-webfont.ttf?v=4.3.0') format('truetype'), url('" + staticPath + "/fonts/fontawesome-webfont.svg?v=4.3.0#fontawesomeregular') format('svg');\
                font-weight: normal;\
                font-style: normal;\
              }\
              .ie-edge .checkout-page .spinner-overlay .ajax-loader .fa-spinner:before {\
                font-family: 'FontAwesomeOrg';\
              }\
          "));

          document.head.appendChild(newStyle);
        }
    }

};

})(this, Site, jQuery);