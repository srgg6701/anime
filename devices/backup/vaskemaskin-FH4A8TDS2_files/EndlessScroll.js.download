Site.EndlessScroll = (function (window, S, out, $) {
	
    /**
     * initialize the endless scroll into the pages (Category level2, Archive articles Component and etc. )
     * @param {String} endlessScrollID: the area of showing the content and will be appended the new content after the existing one. 
     * @param {String} endlessScrollUrl:  the url for retrieving the new content.
     * @param {String} endlessScrollPageCount:  the total page count.
     * @returns {void}
     */
	var init = function() {

		var $target, 
			jsonELS = S.Config.globals.jsonELS;
		
		// Remove any scroll event bound in the 'autobrowse' namespace.
		$(window).off('scroll.autobrowse');
		
		if(typeof jsonELS !== 'undefined' && Object.keys(jsonELS).length){
		    var scrollAreaId = jsonELS.endlessScrollID;
		    var retrieveDataURL = jsonELS.endlessScrollUrl;
		    var pageCount = parseInt(jsonELS.endlessScrollPageCount, 10) + 1;
		    var currentOffset = 0;
		    var elLoader = $("#endlessLoader");
		    
		    $target = $("#"+scrollAreaId);
		    if($('#no-products').is(':visible')) {
		        $target = $('#other-products');
		    }
		    
			
			$target.autobrowse({
		        url: function (offset) {
		     		currentOffset = offset;
		        	return retrieveDataURL + offset;
		        },
		        template: function (response) {
		       		if(parseInt(pageCount) > parseInt(currentOffset)) {
		       			return response;
		       		} else {
		       			elLoader.hide();
		       			return '';
		       		}
		        },
		        itemsReturned: function (response) { return 1; },
		        afterRendering: function () {},        
		        offset: 1,
		        max: pageCount,        
		        loader: elLoader,
		        useCache: false,
		        htmlResponse: true,
		        sensitivity: 0,
		        expiration: 1,
		        complete: function(response) {

		            // Load the images
		            setTimeout(function(){
		                Site.Common.bLazyRevalidate();
		            },100);
		        	
		        	// Loads Bazaarvoice inline ratings for new products fetched with endless scroll. 
		        	try {
		        		$BV.ui( 'rr', 'inline_ratings', {		        	
		        			productIds : globals.BVRatingStarProducts,
		        			containerPrefix : 'BVRRInlineRating'
		        		}); 
		        	}
		        	catch (e) { Site.Common.out(e.message, 'error'); }
		        	
		        	// ECOM-9077 - Loads the store stock of "My store" for mini-products.
		        	$('.no-row').getMiniProductStoreStock();
		        	
			        // ECOM-10940	
		        	S.StockFilter.showNoProductsNotification();
		        	
		        },
		        finished: function(response) {
			        // ECOM-10940 
		            S.StockFilter.showOtherProducts();

		            // Load the images
                    Site.Common.bLazyRevalidate();
		            
		        }
		    });
		}
	};

    return {
        
        /** 
         * Initial Endless Scroll for category level2 page.
         * @returns {void}
         */
        init : init

        
    };
	
}(this, Site, Site.Common.out, jQuery));